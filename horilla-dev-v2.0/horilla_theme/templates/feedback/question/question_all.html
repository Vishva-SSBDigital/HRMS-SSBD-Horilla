{% load widget_tweaks %}
{% load static i18n %}
{% load basefilters %}

<style>
    .oh-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 100;
        overflow-y: auto;
    }

    .oh-modal__dialog {
        position: relative;
        margin: 1rem auto;
        width: 95%;
        max-width: 600px;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .oh-modal__dialog-header {
        position: relative;
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .oh-modal__dialog-body {
        padding: 1.5rem;
    }

    .oh-modal__dialog-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .oh-modal__close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
    }

    /* Transition styles */
    [x-transition] {
        transition: all 0.3s ease;
    }
</style>

<div class="row">
    <div class="col-12 col-sm-12 col-md-12 col-lg-12">
        <div class="oh-card p-0" x-data="{showQuestions: true}">
            <div class="oh-card__header mb-0 p-4">
                <a href="#" class="px-4 py-2 bg-primary-600 text-white rounded-md text-xs flex w-28 justify-center items-center gap-2 hover:bg-primary-800 transition duration-300"
                    x-show="showQuestions" @click="showQuestions = false"
                    style="width: fit-content;">
                    <ion-icon class="me-2" name="eye-off-outline"></ion-icon>
                    {% trans "Hide Questions" %}
                </a>
                <a href="#" class="px-4 py-2 bg-primary-600 text-white rounded-md text-xs flex w-28 justify-center items-center gap-2 hover:bg-primary-800 transition duration-300"
                    x-show="!showQuestions" @click="showQuestions = true"
                    style="width: fit-content;">
                    <ion-icon class="me-2" name="eye-outline"></ion-icon>
                    {% trans "Show Questions" %}
                </a>
            </div>

            <div class="oh-card__body p-0" x-show="showQuestions">
                <div class="p-5 ps-2 pe-2 pt-0">
                    <table class="w-full">
                        <thead class="sticky top-0 bg-[white] z-[1]">
                            <tr class="border-b border-[#ececec]">
                                <th class="text-sm font-medium text-left p-3" style="width:30%;">{% trans "Question Type" %}</th>
                                <th class="text-sm font-medium text-left p-3">{% trans "Question" %}</th>
                                <th class="stickyright text-sm font-medium text-center p-3 w-10">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in form_list %}
                                <tr class="border-b border-[#ebebeb]" id="questionParent{{form.instance.id}}">
                                    <!-- Question Type -->
                                    <td class="text-sm text-left p-3 text-[#666]">
                                        {{ form.instance.get_question_type_display }}
                                    </td>

                                    <!-- Question and Options -->
                                    <td class="text-sm text-left p-3 text-[#666]">
                                        <div class="font-medium mb-2">{{ form.instance.question }}</div>

                                        {% if form.instance.question_type == "4" %}  <!-- Multiple choice -->
                                            <div x-data="{showOptions: false}">
                                                <a href="#" class="px-3 py-1 bg-[white] rounded-md text-xs flex items-center gap-2 border border-primary-500 hover:border-primary-600 transition duration-300 cursor-pointer w-fit"
                                                    @click="showOptions = !showOptions" x-text="showOptions ? '{% trans "Hide Options" %}' : '{% trans "Show Options" %}'">
                                                    <ion-icon class="ms-1" x-bind:name="showOptions ? 'caret-up-outline' : 'caret-down-outline'"></ion-icon>
                                                </a>
                                                <div class="mt-2 grid grid-cols-2 gap-2" x-show="showOptions" x-transition>

                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs text-muted mt-1">1:</span>
                                                        <span>{{ form.option_a.value }}</span>
                                                    </div>

                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs text-muted mt-1">2:</span>
                                                        <span>{{ form.option_b.value }}</span>
                                                    </div>

                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs text-muted mt-1">3:</span>
                                                        <span>{{ form.option_c.value }}</span>
                                                    </div>

                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs text-muted mt-1">4:</span>
                                                        <span>{{ form.option_d.value }}</span>
                                                    </div>

                                                </div>
                                            </div>
                                        {% endif %}
                                    </td>

                                    <!-- Actions -->
                                    <td class="stickyright text-sm text-center p-3 text-[#666]">
                                        <div class="flex justify-center gap-1">
                                            {% if perms.pms.change_question or request.user|filtersubordinates %}
                                                <button @click="$dispatch('open-modal-{{form.instance.id}}')"
                                                    class="oh-btn oh-btn--light-bkg"
                                                    onclick="event.stopPropagation()">
                                                    <ion-icon name="create-outline"></ion-icon>
                                                </button>
                                            {% endif %}
                                            {% if perms.pms.delete_question or request.user|filtersubordinates %}
                                                <a hx-confirm="{% trans 'Do you want to delete the question?' %}"
                                                    hx-post="{% url 'question-delete' id=form.instance.id %}"
                                                    hx-target="#questionParent{{form.instance.id}}"
                                                    hx-swap="outerHTML"
                                                    class="oh-btn oh-btn--danger-outline">
                                                    <ion-icon name="trash-outline"></ion-icon>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>

                                <div x-data="{
                                    open: false,
                                    questionType: '{{ form.instance.question_type }}',
                                    showOptions: '{{ form.instance.question_type }}' === '4',
                                    init() {
                                        this.$watch('questionType', (value) => {
                                            this.showOptions = value === '4';
                                        });
                                    }
                                }"
                                x-show="open"
                                @open-modal-{{form.instance.id}}.window="open = true"
                                @keydown.escape.window="open = false"
                                class="oh-modal fixed inset-0 z-[100] overflow-y-auto"
                                :class="{ 'flex items-center justify-center': open, 'hidden': !open }"
                                x-transition>

                                    <div x-show="open"
                                        x-transition:enter="ease-out duration-300"
                                        x-transition:enter-start="opacity-0"
                                        x-transition:enter-end="opacity-100"
                                        x-transition:leave="ease-in duration-200"
                                        x-transition:leave-start="opacity-100"
                                        x-transition:leave-end="opacity-0"
                                        class="fixed inset-0 bg-gray-900 bg-opacity-50"
                                        @click="open = false">
                                    </div>

                                    <div x-show="open"
                                        x-transition:enter="ease-out duration-300"
                                        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                                        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                                        x-transition:leave="ease-in duration-200"
                                        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                                        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                                        class="oh-modal__dialog bg-white rounded-lg shadow-xl transform transition-all sm:w-full sm:max-w-lg"
                                        style="padding: 30px; border-radius: 0px; margin-top:-10%;">

                                        <div style="padding:20px;">
                                            <h3 class="oh-modal__dialog-title text-lg leading-6 font-medium text-gray-900" style="margin-left:-3%;">
                                                {% trans "Edit Question" %}
                                            </h3>
                                            <button @click="open = false"
                                                    class="oh-modal__close absolute top-4 right-4 mt-5"  style="margin-right:1%;">
                                                <ion-icon name="close-outline" class="text-gray-500 hover:text-gray-700"></ion-icon>
                                            </button>
                                        </div>

                                        <div class="oh-modal__dialog-body px-4 pb-4 sm:p-6 sm:pt-0" style="border: 1px solid #e5e7eb;padding: 18px;border-radius: 8px;">
                                            <form action="{% url 'question-update' temp_id=question_template.id q_id=form.instance.id %}" method="post">
                                                {% csrf_token %}

                                                <div class="mb-4">
                                                    <label class="oh-label flex">
                                                        {% trans "Question Type" %}
                                                    </label>
                                                    {% render_field form.question_type class="oh-input w-full" x-model="questionType" %}
                                                </div>

                                                <div class="mb-4">
                                                    <label class="oh-label flex">
                                                        {% trans "Question" %}
                                                    </label>
                                                    {% render_field form.question class="oh-input w-full" %}
                                                </div>

                                                <div x-show="showOptions" x-transition class="mb-4">
                                                    <label class="oh-label flex">
                                                        {% trans "Options" %}
                                                    </label>
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                        <div>
                                                            <label class="oh-label block text-xs text-gray-500 mb-1">{% trans "Option 1" %}</label>
                                                            {% render_field form.option_a class="oh-input w-full" %}
                                                        </div>
                                                        <div>
                                                            <label class="oh-label block text-xs text-gray-500 mb-1">{% trans "Option 2" %}</label>
                                                            {% render_field form.option_b class="oh-input w-full" %}
                                                        </div>
                                                        <div>
                                                            <label class="oh-label block text-xs text-gray-500 mb-1">{% trans "Option 3" %}</label>
                                                            {% render_field form.option_c class="oh-input w-full" %}
                                                        </div>
                                                        <div>
                                                            <label class="oh-label block text-xs text-gray-500 mb-1">{% trans "Option 4" %}</label>
                                                            {% render_field form.option_d class="oh-input w-full" %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="oh-modal__dialog-footer flex justify-end space-x-3 mt-6">
                                                    <button type="submit"
                                                            class="oh-btn oh-btn--secondary mt-2 mr-0 pl-4 pr-5 oh-btn--w-100-resp">
                                                        {% trans "Save" %}
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function() {
    {% for form in form_list %}
    const questionTypeSelect{{form.instance.id}} = document.querySelector('#pmsQuestion{{form.instance.id}} select[name="question_type"]');
    if (questionTypeSelect{{form.instance.id}}) {
        questionTypeSelect{{form.instance.id}}.addEventListener('change', function() {
            const modal = this.closest('[x-data]');
            const alpineData = Alpine.$data(modal);
            alpineData.showOptions = this.value === '4';
        });
    }
    {% endfor %}
});

$(document).ready(function () {
    $(".oh-select--qa-change").select2();
});

</script>

<script>
// Show/hide options based on question type
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id^="questionEditModal"]').forEach(modal => {
        const questionType = modal.querySelector('select[name="question_type"]');
        const optionsSection = modal.querySelector('#questionOptionsSection');

        if (questionType && optionsSection) {
            // Initial state
            optionsSection.style.display = questionType.value === '4' ? 'block' : 'none';

            // Change handler
            questionType.addEventListener('change', function() {
                optionsSection.style.display = this.value === '4' ? 'block' : 'none';
            });
        }
    });
});
</script>
