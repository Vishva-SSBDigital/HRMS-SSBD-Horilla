{% comment %} {% load i18n %}
<div class="oh-modal__dialog-body" id="PromotionModalTarget">
  <form
    method="post"
    class="oh-form"
    hx-post="{% if is_update %}{% url 'promotion:update' instance.id %}{% else %}{% url 'promotion:create' %}{% endif %}"
    hx-target="#PromotionModalTarget"
    hx-swap="innerHTML"
  >
    {% csrf_token %}

    <div class="oh-grid oh-grid--2">
      <!-- Employee lookup -->
      <div class="oh-input-group">
        <label class="oh-label">{% trans "Employee" %}</label>
        {{ form.employee }}
        {% for e in form.employee.errors %}<div class="oh-input__error">{{ e }}</div>{% endfor %}
      </div>

      <!-- Proposed Status -->
      <div class="oh-input-group">
        <label class="oh-label">{% trans "Proposed Employee Status" %}</label>
        {{ form.proposed_status }}
        {% for e in form.proposed_status.errors %}<div class="oh-input__error">{{ e }}</div>{% endfor %}
      </div>

      <!-- Proposed Designation -->
      <div class="oh-input-group" style="grid-column:1/-1">
        <label class="oh-label">{% trans "Proposed Employee New Grade/Designation" %}</label>
        {{ form.proposed_designation }}
        {% for e in form.proposed_designation.errors %}<div class="oh-input__error">{{ e }}</div>{% endfor %}
      </div>

      <!-- Auto-filled employee details -->
      <div id="promo-emp-details" class="oh-grid oh-grid--2" style="grid-column: 1/-1">
        {% include "promotion/_employee_autofill_fields.html" with employee=None lb=None %}
      </div>

      <!-- Auto Calculations (Adjusted leave + Basic) -->
      <div id="promo-proposal-fields" class="oh-grid oh-grid--2" style="grid-column: 1/-1">
        {% include "promotion/_proposal_fields.html" with adjusted=None proposed_basic=None %}
      </div>

      <!-- Effective from -->
      <div class="oh-input-group">
        <label class="oh-label">{{ form.effective_from.label }}</label>
        {{ form.effective_from }}
        {% for e in form.effective_from.errors %}<div class="oh-input__error">{{ e }}</div>{% endfor %}
      </div>

      <!-- hidden snapshots -->
      {{ form.current_status }} {{ form.current_designation }}
      {{ form.current_cl }} {{ form.current_pl }} {{ form.current_sl }}
      {{ form.adjusted_cl }} {{ form.adjusted_pl }} {{ form.adjusted_sl }}
      {{ form.proposed_basic_salary }}
    </div>

    <div class="oh-modal__dialog-footer mt-2">
      <button type="submit" class="oh-btn oh-btn--secondary oh-btn--shadow">{% trans "Save" %}</button>
      <button type="button" class="oh-btn oh-btn--light" id="promoCancelBtn">{% trans "Cancel" %}</button>
    </div>
  </form>
</div>

<script>
  function closePromotionModal() {
    const modal = document.getElementById('PromotionModal');
    if (modal) modal.style.display = 'none';
  }
  document.getElementById('promoCancelBtn')?.addEventListener('click', closePromotionModal);

  document.body.addEventListener("promotion:created", function() {
    closePromotionModal();
    location.reload();
  });
  document.body.addEventListener("promotion:updated", function() {
    closePromotionModal();
    location.reload();
  });
</script> {% endcomment %}


{% comment %} {% load i18n %}
<div class="oh-modal__dialog-body" id="PromotionModalTarget">
  <form
    method="post"
    class="oh-form"
    hx-post="{% if is_update %}{% url 'promotion:update' instance.id %}{% else %}{% url 'promotion:create' %}{% endif %}"
    hx-target="#PromotionModalTarget"
    hx-swap="innerHTML"
  >
    {% csrf_token %}

    <div class="oh-grid oh-grid--2">
      <!-- Employee -->
      <div class="oh-input-group">
        <label class="oh-label">{% trans "Employee" %}</label>
        {{ form.employee }}
      </div>

      <!-- Department (populated + selected via OOB swap on employee change) -->
      <div class="oh-input-group">
        <label class="oh-label">{% trans "Department" %}</label>
        {{ form.department }}
      </div>

      <!-- Proposed Designation -->
      <div class="oh-input-group" style="grid-column:1/-1">
        <label class="oh-label">{% trans "Proposed Employee New Grade/Designation" %}</label>
        {{ form.proposed_designation }}
      </div>

      <!-- Auto-filled employee details -->
      <div id="promo-emp-details" class="oh-grid oh-grid--2" style="grid-column:1/-1">
        {% include "promotion/_employee_autofill_fields.html" with employee=None lb=None %}
      </div>

      <!-- Auto-calculated proposal -->
      <div id="promo-proposal-fields" class="oh-grid oh-grid--2" style="grid-column:1/-1">
        {% include "promotion/_proposal_fields.html" with adjusted=None proposed_basic=None %}
      </div>

      <!-- Effective from -->
      <div class="oh-input-group">
        <label class="oh-label">{{ form.effective_from.label }}</label>
        {{ form.effective_from }}
      </div>

      <!-- hidden snapshots -->
      {{ form.current_status }} {{ form.current_designation }}
      {{ form.current_cl }} {{ form.current_pl }} {{ form.current_sl }}
      {{ form.adjusted_cl }} {{ form.adjusted_pl }} {{ form.adjusted_sl }}
      {{ form.proposed_basic_salary }}
    </div>

    <div class="oh-modal__dialog-footer mt-2">
      <button type="submit" class="oh-btn oh-btn--secondary oh-btn--shadow">{% trans "Save" %}</button>
      <button type="button" class="oh-btn oh-btn--light" id="promoCancelBtn">{% trans "Cancel" %}</button>
    </div>
  </form>
</div>
<script>
  document.getElementById('promoCancelBtn')?.addEventListener('click', () => {
    const modal = document.getElementById('PromotionModal');
    if (modal) modal.style.display = 'none';
  });
  document.body.addEventListener("promotion:created", () => { location.reload(); });
  document.body.addEventListener("promotion:updated", () => { location.reload(); });
</script> {% endcomment %}


{% comment %} {% load i18n %}
<div class="oh-modal__dialog-body" id="PromotionModalTarget">
  <form
    method="post"
    class="oh-form"
    hx-post="{% if is_update %}{% url 'promotion:update' instance.id %}{% else %}{% url 'promotion:create' %}{% endif %}"
    hx-target="#PromotionModalTarget"
    hx-swap="innerHTML"
  >
    {% csrf_token %}

    <!-- Employee dropdown + Department -->
    <div class="oh-card oh-card--flat" style="margin-bottom:10px;">
      <div class="oh-card__body">
        <div class="oh-grid oh-grid--2">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Employee" %}</label>
            {{ form.employee }}
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Department" %}</label>
            {{ form.department }}
          </div>
        </div>
      </div>
    </div>

    <!-- Auto-filled current details (replaced by HTMX on employee change) -->
    <div class="oh-card oh-card--flat" style="margin-bottom:10px;">
      <div class="oh-card__body">
        <div id="promo-emp-details" class="oh-grid oh-grid--2">
          {% include "promotion/_employee_autofill_fields.html" with employee=None lb=None %}
        </div>

        <!-- Proposed fields -->
        <div class="oh-grid oh-grid--2" style="margin-top:8px;">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Proposed Employee Status" %}</label>
            {{ form.proposed_status }}
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Proposed Employee New Grade/Designation" %}</label>
            {{ form.proposed_designation }}
          </div>
        </div>
      </div>
    </div>

    <!-- Leave snapshot + Adjusted proposal -->
    <div class="oh-card oh-card--flat" style="margin-bottom:10px;">
      <div class="oh-card__body">
        <div class="oh-grid oh-grid--3">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Leave (CL)" %}</label>
            <input class="oh-input" id="v_current_cl" value="0" readonly>
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Leave (PL)" %}</label>
            <input class="oh-input" id="v_current_pl" value="0" readonly>
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Leave (SL)" %}</label>
            <input class="oh-input" id="v_current_sl" value="0" readonly>
          </div>
        </div>

        <div id="promo-proposal-fields" class="oh-grid oh-grid--3" style="margin-top:8px;">
          {% include "promotion/_proposal_fields.html" with adjusted=None proposed_basic=None %}
        </div>
      </div>
    </div>

    <!-- Effective From -->
    <div class="oh-grid oh-grid--2">
      <div class="oh-input-group">
        <label class="oh-label">{{ form.effective_from.label }}</label>
        {{ form.effective_from }}
      </div>
    </div>

    <!-- Hidden snapshots (real ModelForm fields). We will replace these via OOB from the partial -->
    {{ form.current_status }}
    {{ form.current_designation }}
    {{ form.current_cl }} {{ form.current_pl }} {{ form.current_sl }}
    {{ form.adjusted_cl }} {{ form.adjusted_pl }} {{ form.adjusted_sl }}
    {{ form.proposed_basic_salary }}

    <div class="oh-modal__dialog-footer mt-2">
      <button type="submit" class="oh-btn oh-btn--secondary oh-btn--shadow">{% trans "Submit" %}</button>
      <button type="button" class="oh-btn oh-btn--light" id="promoCancelBtn">{% trans "Cancel" %}</button>
    </div>
  </form>
</div>

<script>
  document.getElementById('promoCancelBtn')?.addEventListener('click', () => {
    const modal = document.getElementById('PromotionModal');
    if (modal) modal.style.display = 'none';
  });
  document.body.addEventListener("promotion:created", () => { location.reload(); });
  document.body.addEventListener("promotion:updated", () => { location.reload(); });
</script> {% endcomment %}


{% load i18n %}
<div class="oh-modal__dialog-body" id="PromotionModalTarget">
  {% if form.non_field_errors %}
  <div class="oh-alert oh-alert--danger">{{ form.non_field_errors }}</div>
{% endif %}
{% for field in form %}
  {% if field.errors %}
    <div class="oh-text--danger small">{{ field.label }}: {{ field.errors|striptags }}</div>
  {% endif %}
{% endfor %}
  <form
    method="post"
    class="oh-form"
    hx-post="{% if is_update %}{% url 'promotion:update' instance.id %}{% else %}{% url 'promotion:create' %}{% endif %}"
    hx-target="#PromotionModalTarget"
    hx-swap="innerHTML"
  >
    {% csrf_token %}

    <!-- Employee dropdown + Department -->
    <div class="oh-card oh-card--flat" style="margin-bottom:10px;">
      <div class="oh-card__body">
        <div class="oh-grid oh-grid--2">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Employee" %}</label>
            {{ form.employee }}
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Department" %}</label>
            {{ form.department }}
          </div>
        </div>
      </div>
    </div>

    <!-- Auto-filled current details (HTMX) + visible read-only status/designation -->
    <div class="oh-card oh-card--flat" style="margin-bottom:10px;">
      <div class="oh-card__body">
        <div id="promo-emp-details" class="oh-grid oh-grid--2">
          {% include "promotion/_employee_autofill_fields.html" with employee=None lb=None %}
        </div>

        <!-- Visible, read-only display fields filled via OOB -->
        <div class="oh-grid oh-grid--2" style="margin-top:8px;">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Status" %}</label>
            <input class="oh-input" id="v_current_status" value="" readonly>
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Designation" %}</label>
            <input class="oh-input" id="v_current_designation" value="" readonly>
          </div>
        </div>

        <!-- Proposed fields -->
        {% comment %} <div class="oh-grid oh-grid--2" style="margin-top:8px;">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Proposed Employee Status" %}</label>
            {{ form.proposed_status }}
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Proposed Employee New Grade/Designation" %}</label>
            {{ form.proposed_designation }}
          </div>
        </div>
      </div>
    </div> {% endcomment %}
       <div class="oh-input-group">
      <label class="oh-label">{% trans "Proposed Employee New Grade/Designation" %}</label>
      <div id="proposed-wrapper">
        {{ form.proposed_designation }}  {# initial select; will be fully replaced on dept change #}
      </div>
    </div>

    <!-- Leave snapshot + Adjusted proposal -->
    <div class="oh-card oh-card--flat" style="margin-bottom:10px;">
      <div class="oh-card__body">
        <div class="oh-grid oh-grid--3">
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Leave (CL)" %}</label>
            <input class="oh-input" id="v_current_cl" value="0" readonly>
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Leave (PL)" %}</label>
            <input class="oh-input" id="v_current_pl" value="0" readonly>
          </div>
          <div class="oh-input-group">
            <label class="oh-label">{% trans "Current Leave (SL)" %}</label>
            <input class="oh-input" id="v_current_sl" value="0" readonly>
          </div>
        </div>

        <div id="promo-proposal-fields" class="oh-grid oh-grid--3" style="margin-top:8px;">
          {% include "promotion/_proposal_fields.html" with adjusted=None proposed_basic=None %}
        </div>
      </div>
    </div>

    <!-- Effective From -->
    <div class="oh-grid oh-grid--2">
      <div class="oh-input-group">
        <label class="oh-label">{{ form.effective_from.label }}</label>
        {{ form.effective_from }}
      </div>
    </div>

    <!-- Hidden snapshots (submitted) -->
    {% comment %} {{ form.current_status }}
    {{ form.current_designation }}
    {{ form.current_cl }} {{ form.current_pl }} {{ form.current_sl }}
    {{ form.adjusted_cl }} {{ form.adjusted_pl }} {{ form.adjusted_sl }}
    {{ form.proposed_basic_salary }} {% endcomment %}

    <div class="oh-modal__dialog-footer mt-2">
      <button type="submit" class="oh-btn oh-btn--secondary oh-btn--shadow">{% trans "Submit" %}</button>
      <button type="button" class="oh-btn oh-btn--light" id="promoCancelBtn">{% trans "Cancel" %}</button>
    </div>
  </form>
</div>

<script>
  document.getElementById('promoCancelBtn')?.addEventListener('click', () => {
    const modal = document.getElementById('PromotionModal');
    if (modal) modal.style.display = 'none';
  });
  document.body.addEventListener("promotion:created", () => { location.reload(); });
  document.body.addEventListener("promotion:updated", () => { location.reload(); });
</script>
